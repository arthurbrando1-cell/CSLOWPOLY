<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS FPS - Multiplayer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            background: #000;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100vh;
        }

        /* Menu Principal */
        #mainMenu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #mainMenu h1 {
            color: #ff6b35;
            font-size: 3em;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 107, 53, 0.5);
        }

        #mainMenu input {
            padding: 15px 30px;
            font-size: 1.2em;
            border: 2px solid #ff6b35;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 5px;
            margin: 10px;
            min-width: 300px;
        }

        #mainMenu button {
            padding: 15px 50px;
            font-size: 1.3em;
            background: #ff6b35;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }

        #mainMenu button:hover {
            background: #ff8555;
            transform: scale(1.05);
        }

        /* HUD */
        #hud {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: none;
        }

        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
        }

        #crosshair::before,
        #crosshair::after {
            content: '';
            position: absolute;
            background: #00ff00;
        }

        #crosshair::before {
            width: 2px;
            height: 20px;
            left: 9px;
        }

        #crosshair::after {
            width: 20px;
            height: 2px;
            top: 9px;
        }

        #stats {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: white;
            font-size: 1.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        #health {
            color: #00ff00;
            margin-bottom: 10px;
        }

        #ammo {
            color: #ffff00;
        }

        #weapon {
            color: #ff6b35;
            margin-bottom: 10px;
        }

        #killFeed {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 1em;
            text-align: right;
            max-width: 300px;
        }

        .kill {
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            margin: 5px 0;
            border-radius: 3px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        #scoreboard {
            position: absolute;
            top: 50px;
            left: 20px;
            color: white;
            font-size: 1.2em;
        }

        #chat {
            position: absolute;
            bottom: 80px;
            left: 20px;
            width: 400px;
            pointer-events: all;
        }

        #chatMessages {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            color: white;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        #chatInput {
            width: 100%;
            padding: 10px;
            background: rgba(0,0,0,0.7);
            border: 1px solid #ff6b35;
            color: white;
            display: none;
        }

        /* Tela de Morte */
        #deathScreen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,0,0,0.3);
            padding: 50px;
            border-radius: 10px;
            text-align: center;
            color: white;
            font-size: 2em;
            display: none;
        }

        /* Loading */
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 2em;
            z-index: 999;
        }

        /* Mobile Controls */
        #mobileControls {
            display: none;
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 200px;
            pointer-events: all;
        }

        #joystick {
            position: absolute;
            left: 50px;
            bottom: 50px;
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            border: 2px solid white;
        }

        #fireButton {
            position: absolute;
            right: 50px;
            bottom: 50px;
            width: 80px;
            height: 80px;
            background: rgba(255,0,0,0.5);
            border-radius: 50%;
            border: 2px solid white;
            color: white;
            font-size: 1.5em;
        }

        @media (max-width: 768px) {
            #mobileControls { display: block; }
        }
    </style>
</head>
<body>
    <!-- Menu Principal -->
    <div id="mainMenu">
        <h1>游꿡 COUNTER STRIKE FPS</h1>
        <input type="text" id="playerName" placeholder="Digite seu nome" maxlength="15">
        <input type="text" id="roomCode" placeholder="C칩digo da sala (opcional)" maxlength="10">
        <button id="startButton">ENTRAR NA PARTIDA</button>
        <p style="color: #888; margin-top: 20px;">WASD - Mover | Mouse - Mirar | Click - Atirar | R - Recarregar | 1-3 - Trocar Arma</p>
    </div>

    <!-- Loading -->
    <div id="loading">Carregando...</div>

    <!-- Game Canvas -->
    <canvas id="gameCanvas"></canvas>

    <!-- HUD -->
    <div id="hud">
        <div id="crosshair"></div>
        <div id="stats">
            <div id="health">仇벒잺 HP: 100</div>
            <div id="weapon">游댦 Pistol</div>
            <div id="ammo">游닍 12 / 60</div>
        </div>
        <div id="killFeed"></div>
        <div id="scoreboard">
            <div style="background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px;">
                <div id="score">Kills: 0 | Deaths: 0</div>
            </div>
        </div>
        <div id="chat">
            <div id="chatMessages"></div>
            <input type="text" id="chatInput" placeholder="Pressione T para chat..." maxlength="100">
        </div>
        <div id="deathScreen">
            游 VOC칅 MORREU<br>
            <span style="font-size: 0.5em;">Respawnando em <span id="respawnTimer">5</span>s</span>
        </div>
    </div>

    <!-- Mobile Controls -->
    <div id="mobileControls">
        <div id="joystick"></div>
        <button id="fireButton">游댠</button>
    </div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ==================== CONFIGURA칂츾O FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAIKPooiHzcB5d8_mRiDMyiam4AYel4lZs",
            authDomain: "cs-low-poly.firebaseapp.com",
            databaseURL: "https://cs-low-poly-default-rtdb.firebaseio.com",
            projectId: "cs-low-poly",
            storageBucket: "cs-low-poly.firebasestorage.app",
            messagingSenderId: "291417778108",
            appId: "1:291417778108:web:881869dd93735c6167edb9"
        };

        // Inicializar Firebase (com tratamento de erro)
        let database = null;
        let firebaseEnabled = false;
        
        try {
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                firebaseEnabled = true;
                console.log("Firebase inicializado com sucesso!");
            }
        } catch (error) {
            console.warn("Firebase n칚o configurado. Modo offline.", error);
            firebaseEnabled = false;
        }

        // ==================== VARI츼VEIS GLOBAIS ====================
        let scene, camera, renderer, clock;
        let player, players = {};
        let keys = {}, mouse = { x: 0, y: 0 };
        let isPointerLocked = false;
        let gameStarted = false;
        let myPlayerId = 'player_' + Math.random().toString(36).substr(2, 9);
        let roomId = 'default_room';

        // Player stats
        let playerStats = {
            name: '',
            health: 100,
            kills: 0,
            deaths: 0,
            isAlive: true,
            position: { x: 0, y: 1, z: 0 },
            rotation: { x: 0, y: 0 },
            currentWeapon: 0
        };

        // Weapons
        const weapons = [
            { name: 'Pistol', damage: 25, ammo: 12, maxAmmo: 60, fireRate: 300, spread: 0.02, icon: '游댦' },
            { name: 'Rifle', damage: 35, ammo: 30, maxAmmo: 90, fireRate: 100, spread: 0.01, icon: '游댦' },
            { name: 'Knife', damage: 75, ammo: Infinity, maxAmmo: Infinity, fireRate: 500, spread: 0, icon: '游댥' }
        ];
        
        let currentWeapon = weapons[0];
        let currentAmmo = currentWeapon.ammo;
        let reserveAmmo = currentWeapon.maxAmmo;
        let canFire = true;
        let isReloading = false;

        // ==================== INICIALIZA칂츾O ====================
        document.getElementById('loading').style.display = 'none';

        document.getElementById('startButton').addEventListener('click', startGame);
        document.getElementById('playerName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') startGame();
        });

        function startGame() {
            const nameInput = document.getElementById('playerName').value.trim();
            const roomInput = document.getElementById('roomCode').value.trim();
            
            if (!nameInput) {
                alert('Digite seu nome!');
                return;
            }

            playerStats.name = nameInput;
            if (roomInput) roomId = roomInput;

            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            
            initGame();
            gameStarted = true;
        }

        function initGame() {
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            scene.fog = new THREE.Fog(0x87ceeb, 0, 100);

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 0);

            // Renderer
            const canvas = document.getElementById('gameCanvas');
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;

            // Clock
            clock = new THREE.Clock();

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(10, 20, 10);
            dirLight.castShadow = true;
            dirLight.shadow.camera.left = -50;
            dirLight.shadow.camera.right = 50;
            dirLight.shadow.camera.top = 50;
            dirLight.shadow.camera.bottom = -50;
            scene.add(dirLight);

            // Create Map
            createMap();

            // Create Player
            createPlayer();

            // Setup Controls
            setupControls();

            // Setup Firebase
            if (firebaseEnabled) {
                setupFirebase();
            }

            // Start Loop
            animate();
        }

        // ==================== MAPA ====================
        function createMap() {
            // Ch칚o
            const floorGeometry = new THREE.PlaneGeometry(100, 100);
            const floorMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x808080,
                roughness: 0.8
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            floor.userData.isGround = true;
            scene.add(floor);

            // Paredes externas
            const walls = [
                { x: 0, z: -50, width: 100, height: 10 },
                { x: 0, z: 50, width: 100, height: 10 },
                { x: -50, z: 0, width: 10, height: 100 },
                { x: 50, z: 0, width: 10, height: 100 }
            ];

            walls.forEach(wall => {
                const geometry = new THREE.BoxGeometry(
                    wall.width || 2,
                    wall.height || 5,
                    wall.width ? 2 : wall.height
                );
                const material = new THREE.MeshStandardMaterial({ color: 0x404040 });
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(wall.x, 2.5, wall.z);
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                mesh.userData.isWall = true;
                scene.add(mesh);
            });

            // Caixas (estilo CS)
            const boxes = [
                { x: -10, z: -10, size: 2 },
                { x: 10, z: 10, size: 2 },
                { x: -15, z: 15, size: 3 },
                { x: 15, z: -15, size: 2.5 },
                { x: 0, z: 0, size: 2 },
                { x: -20, z: 0, size: 2 },
                { x: 20, z: 0, size: 2 },
                { x: 0, z: -20, size: 3 },
                { x: 0, z: 20, size: 2.5 }
            ];

            boxes.forEach(box => {
                const geometry = new THREE.BoxGeometry(box.size, box.size, box.size);
                const material = new THREE.MeshStandardMaterial({ 
                    color: 0x8b7355,
                    roughness: 0.9
                });
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(box.x, box.size / 2, box.z);
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                mesh.userData.isWall = true;
                scene.add(mesh);
            });

            // Spawn points (invis칤veis)
            const spawnPoints = [
                new THREE.Vector3(-30, 1, -30),
                new THREE.Vector3(30, 1, 30),
                new THREE.Vector3(-30, 1, 30),
                new THREE.Vector3(30, 1, -30)
            ];
            
            // Posi칞칚o inicial aleat칩ria
            const spawn = spawnPoints[Math.floor(Math.random() * spawnPoints.length)];
            camera.position.copy(spawn);
            playerStats.position = { x: spawn.x, y: spawn.y, z: spawn.z };
        }

        // ==================== PLAYER ====================
        function createPlayer() {
            // Player 칠 a c칙mera (FPS)
            player = {
                velocity: new THREE.Vector3(),
                speed: 5,
                jumpSpeed: 7,
                gravity: -20,
                height: 1.6,
                isGrounded: false,
                isCrouching: false
            };
        }

        // ==================== CONTROLES ====================
        function setupControls() {
            // Keyboard
            document.addEventListener('keydown', (e) => {
                keys[e.key.toLowerCase()] = true;
                
                // Armas
                if (e.key === '1') switchWeapon(0);
                if (e.key === '2') switchWeapon(1);
                if (e.key === '3') switchWeapon(2);
                
                // Reload
                if (e.key === 'r') reload();
                
                // Chat
                if (e.key === 't') {
                    const chatInput = document.getElementById('chatInput');
                    chatInput.style.display = 'block';
                    chatInput.focus();
                }
            });

            document.addEventListener('keyup', (e) => {
                keys[e.key.toLowerCase()] = false;
            });

            // Mouse
            document.addEventListener('click', () => {
                if (!isPointerLocked && gameStarted) {
                    canvas.requestPointerLock();
                }
            });

            document.addEventListener('pointerlockchange', () => {
                isPointerLocked = document.pointerLockElement === canvas;
            });

            document.addEventListener('mousemove', (e) => {
                if (isPointerLocked) {
                    mouse.x += e.movementX * 0.002;
                    mouse.y -= e.movementY * 0.002;
                    mouse.y = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, mouse.y));
                }
            });

            document.addEventListener('mousedown', () => {
                if (isPointerLocked && playerStats.isAlive) {
                    shoot();
                }
            });

            // Chat
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const message = chatInput.value.trim();
                    if (message && firebaseEnabled) {
                        sendChatMessage(message);
                    }
                    chatInput.value = '';
                    chatInput.style.display = 'none';
                    canvas.focus();
                }
            });

            // Resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // ==================== ARMAS ====================
        function switchWeapon(index) {
            if (index < 0 || index >= weapons.length) return;
            
            currentWeapon = weapons[index];
            currentAmmo = currentWeapon.ammo;
            reserveAmmo = currentWeapon.maxAmmo;
            playerStats.currentWeapon = index;
            
            updateHUD();
        }

        function reload() {
            if (isReloading || currentAmmo === currentWeapon.ammo || currentWeapon.name === 'Knife') return;
            
            isReloading = true;
            
            setTimeout(() => {
                const needed = currentWeapon.ammo - currentAmmo;
                const toReload = Math.min(needed, reserveAmmo);
                currentAmmo += toReload;
                reserveAmmo -= toReload;
                isReloading = false;
                updateHUD();
            }, 1500);
        }

        function shoot() {
            if (!canFire || isReloading || currentAmmo <= 0) return;
            
            if (currentWeapon.name !== 'Knife') {
                currentAmmo--;
            }
            
            canFire = false;
            setTimeout(() => canFire = true, currentWeapon.fireRate);

            // Raycast para detectar hit
            const raycaster = new THREE.Raycaster();
            const direction = new THREE.Vector3();
            
            // Adicionar spread
            const spread = currentWeapon.spread;
            direction.set(
                (Math.random() - 0.5) * spread,
                (Math.random() - 0.5) * spread,
                -1
            ).normalize();
            
            camera.getWorldDirection(direction);
            raycaster.set(camera.position, direction);

            // Verificar colis칚o com outros jogadores
            const otherPlayers = Object.values(players);
            const intersects = raycaster.intersectObjects(otherPlayers.map(p => p.mesh).filter(Boolean));

            if (intersects.length > 0 && firebaseEnabled) {
                const hitPlayer = intersects[0].object.userData.playerId;
                const isHeadshot = intersects[0].point.y > intersects[0].object.position.y + 0.7;
                const damage = isHeadshot ? currentWeapon.damage * 2 : currentWeapon.damage;
                
                // Enviar hit para Firebase
                database.ref(`rooms/${roomId}/players/${hitPlayer}/health`).transaction(health => {
                    return Math.max(0, (health || 100) - damage);
                });

                if (isHeadshot) {
                    addKillFeed('HEADSHOT!', '#ff0000');
                }
            }

            // Efeito visual de tiro (muzzle flash)
            createMuzzleFlash();
            
            updateHUD();
        }

        function createMuzzleFlash() {
            const flash = new THREE.PointLight(0xffaa00, 2, 3);
            flash.position.copy(camera.position);
            flash.position.y -= 0.2;
            scene.add(flash);
            
            setTimeout(() => scene.remove(flash), 50);
        }

        // ==================== MOVIMENTO ====================
        function updatePlayer(delta) {
            if (!playerStats.isAlive) return;

            // Rota칞칚o da c칙mera
            camera.rotation.order = 'YXZ';
            camera.rotation.y = mouse.x;
            camera.rotation.x = mouse.y;

            // Movimento
            const moveSpeed = player.speed * (keys.shift ? 1.5 : 1) * (player.isCrouching ? 0.5 : 1);
            const direction = new THREE.Vector3();

            if (keys.w) direction.z -= 1;
            if (keys.s) direction.z += 1;
            if (keys.a) direction.x -= 1;
            if (keys.d) direction.x += 1;

            direction.normalize();
            direction.applyAxisAngle(new THREE.Vector3(0, 1, 0), mouse.x);

            // Aplicar velocidade
            player.velocity.x = direction.x * moveSpeed;
            player.velocity.z = direction.z * moveSpeed;

            // Gravidade
            player.velocity.y += player.gravity * delta;

            // Pulo
            if (keys[' '] && player.isGrounded) {
                player.velocity.y = player.jumpSpeed;
                player.isGrounded = false;
            }

            // Agachar
            player.isCrouching = keys.control;
            const targetHeight = player.isCrouching ? 1.2 : 1.6;
            camera.position.y += (targetHeight - camera.position.y) * 0.1;

            // Aplicar movimento
            const movement = player.velocity.clone().multiplyScalar(delta);
            camera.position.add(movement);

            // Colis칚o com ch칚o
            if (camera.position.y <= 1.6) {
                camera.position.y = 1.6;
                player.velocity.y = 0;
                player.isGrounded = true;
            }

            // Colis칚o com paredes (simples)
            if (Math.abs(camera.position.x) > 48) {
                camera.position.x = Math.sign(camera.position.x) * 48;
                player.velocity.x = 0;
            }
            if (Math.abs(camera.position.z) > 48) {
                camera.position.z = Math.sign(camera.position.z) * 48;
                player.velocity.z = 0;
            }

            // Atualizar posi칞칚o no Firebase
            playerStats.position = {
                x: camera.position.x,
                y: camera.position.y,
                z: camera.position.z
            };
            playerStats.rotation = {
                x: camera.rotation.x,
                y: camera.rotation.y
            };

            if (firebaseEnabled) {
                updateFirebasePlayer();
            }
        }

        // ==================== FIREBASE ====================
        function setupFirebase() {
            // Registrar jogador
            const playerRef = database.ref(`rooms/${roomId}/players/${myPlayerId}`);
            playerRef.set({
                name: playerStats.name,
                health: playerStats.health,
                kills: playerStats.kills,
                deaths: playerStats.deaths,
                isAlive: playerStats.isAlive,
                position: playerStats.position,
                rotation: playerStats.rotation,
                currentWeapon: playerStats.currentWeapon,
                timestamp: Date.now()
            });

            // Desconectar ao sair
            playerRef.onDisconnect().remove();

            // Escutar outros jogadores
            database.ref(`rooms/${roomId}/players`).on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                Object.keys(data).forEach(id => {
                    if (id === myPlayerId) {
                        // Atualizar pr칩pria sa칰de
                        if (data[id].health <= 0 && playerStats.isAlive) {
                            die();
                        }
                        playerStats.health = data[id].health;
                        updateHUD();
                        return;
                    }

                    if (!players[id]) {
                        createOtherPlayer(id, data[id]);
                    } else {
                        updateOtherPlayer(id, data[id]);
                    }
                });

                // Remover jogadores desconectados
                Object.keys(players).forEach(id => {
                    if (!data[id]) {
                        removeOtherPlayer(id);
                    }
                });
            });

            // Escutar chat
            database.ref(`rooms/${roomId}/chat`).limitToLast(1).on('child_added', (snapshot) => {
                const msg = snapshot.val();
                if (msg && msg.playerId !== myPlayerId) {
                    addChatMessage(msg.name, msg.message);
                }
            });
        }

        function updateFirebasePlayer() {
            if (!firebaseEnabled) return;
            
            database.ref(`rooms/${roomId}/players/${myPlayerId}`).update({
                position: playerStats.position,
                rotation: playerStats.rotation,
                health: playerStats.health,
                kills: playerStats.kills,
                deaths: playerStats.deaths,
                isAlive: playerStats.isAlive,
                currentWeapon: playerStats.currentWeapon,
                timestamp: Date.now()
            });
        }

        function createOtherPlayer(id, data) {
            // Criar mesh do jogador
            const geometry = new THREE.CapsuleGeometry(0.3, 1, 4, 8);
            const material = new THREE.MeshStandardMaterial({ color: 0xff0000 });
            const mesh = new THREE.Mesh(geometry, material);
            mesh.castShadow = true;
            mesh.userData.playerId = id;
            scene.add(mesh);

            // Nome do jogador
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 256;
            canvas.height = 64;
            context.fillStyle = 'white';
            context.font = 'Bold 24px Arial';
            context.textAlign = 'center';
            context.fillText(data.name, 128, 40);

            const texture = new THREE.CanvasTexture(canvas);
            const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
            const sprite = new THREE.Sprite(spriteMaterial);
            sprite.position.y = 1.5;
            sprite.scale.set(2, 0.5, 1);

            players[id] = {
                mesh,
                sprite,
                data
            };

            mesh.add(sprite);
        }

        function updateOtherPlayer(id, data) {
            if (!players[id]) return;
            
            const player = players[id];
            player.data = data;

            // Interpolar posi칞칚o
            if (data.position) {
                player.mesh.position.lerp(
                    new THREE.Vector3(data.position.x, data.position.y, data.position.z),
                    0.3
                );
            }

            // Atualizar rota칞칚o
            if (data.rotation) {
                player.mesh.rotation.y = data.rotation.y;
            }

            // Esconder se morto
            player.mesh.visible = data.isAlive;
        }

        function removeOtherPlayer(id) {
            if (players[id]) {
                scene.remove(players[id].mesh);
                delete players[id];
            }
        }

        // ==================== MORTE E RESPAWN ====================
        function die() {
            playerStats.isAlive = false;
            playerStats.deaths++;
            
            document.getElementById('deathScreen').style.display = 'block';
            
            let respawnTime = 5;
            const respawnInterval = setInterval(() => {
                respawnTime--;
                document.getElementById('respawnTimer').textContent = respawnTime;
                
                if (respawnTime <= 0) {
                    clearInterval(respawnInterval);
                    respawn();
                }
            }, 1000);
            
            updateHUD();
        }

        function respawn() {
            playerStats.isAlive = true;
            playerStats.health = 100;
            
            // Spawn aleat칩rio
            const spawnPoints = [
                new THREE.Vector3(-30, 1.6, -30),
                new THREE.Vector3(30, 1.6, 30),
                new THREE.Vector3(-30, 1.6, 30),
                new THREE.Vector3(30, 1.6, -30)
            ];
            const spawn = spawnPoints[Math.floor(Math.random() * spawnPoints.length)];
            camera.position.copy(spawn);
            
            // Resetar armas
            switchWeapon(0);
            
            document.getElementById('deathScreen').style.display = 'none';
            
            if (firebaseEnabled) {
                updateFirebasePlayer();
            }
            
            updateHUD();
        }

        // ==================== HUD ====================
        function updateHUD() {
            document.getElementById('health').textContent = `仇벒잺 HP: ${playerStats.health}`;
            document.getElementById('weapon').textContent = `${currentWeapon.icon} ${currentWeapon.name}`;
            
            if (currentWeapon.name === 'Knife') {
                document.getElementById('ammo').textContent = '游댥 Melee';
            } else {
                document.getElementById('ammo').textContent = `游닍 ${currentAmmo} / ${reserveAmmo}`;
            }
            
            document.getElementById('score').textContent = `Kills: ${playerStats.kills} | Deaths: ${playerStats.deaths}`;
        }

        function addKillFeed(text, color = 'white') {
            const feed = document.getElementById('killFeed');
            const killDiv = document.createElement('div');
            killDiv.className = 'kill';
            killDiv.style.color = color;
            killDiv.textContent = text;
            feed.prepend(killDiv);
            
            setTimeout(() => killDiv.remove(), 5000);
        }

        function addChatMessage(name, message) {
            const chat = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.innerHTML = `<strong>${name}:</strong> ${message}`;
            chat.appendChild(msgDiv);
            chat.scrollTop = chat.scrollHeight;
            
            setTimeout(() => msgDiv.remove(), 10000);
        }

        function sendChatMessage(message) {
            if (!firebaseEnabled) return;
            
            database.ref(`rooms/${roomId}/chat`).push({
                playerId: myPlayerId,
                name: playerStats.name,
                message,
                timestamp: Date.now()
            });
            
            addChatMessage(playerStats.name, message);
        }

        // ==================== GAME LOOP ====================
        function animate() {
            requestAnimationFrame(animate);
            
            if (!gameStarted) return;
            
            const delta = Math.min(clock.getDelta(), 0.1);
            
            updatePlayer(delta);
            
            renderer.render(scene, camera);
        }

        // ==================== INICIAR ====================
        console.log('%c游꿡 CS FPS Multiplayer', 'font-size: 24px; color: #ff6b35; font-weight: bold;');
        console.log('%cControles:', 'font-size: 16px; color: #00ff00;');
        console.log('WASD - Mover');
        console.log('Mouse - Mirar');
        console.log('Click - Atirar');
        console.log('Space - Pular');
        console.log('Shift - Correr');
        console.log('Ctrl - Agachar');
        console.log('R - Recarregar');
        console.log('1-3 - Trocar arma');
        console.log('T - Chat');
        console.log('%c\nDica: Configure o Firebase para multiplayer funcionar!', 'color: yellow;');
    </script>
</body>
</html>
