<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS FPS - Multiplayer (3¬™ Pessoa)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            background: #000;
            cursor: default;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100vh;
        }

        /* Menu Principal */
        #mainMenu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #mainMenu h1 {
            color: #ff6b35;
            font-size: 3em;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 107, 53, 0.5);
        }

        #mainMenu input {
            padding: 15px 30px;
            font-size: 1.2em;
            border: 2px solid #ff6b35;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 5px;
            margin: 10px;
            min-width: 300px;
        }

        #mainMenu button {
            padding: 15px 50px;
            font-size: 1.3em;
            background: #ff6b35;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }

        #mainMenu button:hover {
            background: #ff8555;
            transform: scale(1.05);
        }

        /* HUD */
        #hud {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: none;
        }

        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
        }

        #crosshair::before,
        #crosshair::after {
            content: '';
            position: absolute;
            background: #00ff00;
        }

        #crosshair::before {
            width: 2px;
            height: 20px;
            left: 9px;
        }

        #crosshair::after {
            width: 20px;
            height: 2px;
            top: 9px;
        }

        #stats {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: white;
            font-size: 1.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        #health {
            color: #00ff00;
            margin-bottom: 10px;
        }

        #ammo {
            color: #ffff00;
        }

        #weapon {
            color: #ff6b35;
            margin-bottom: 10px;
        }

        #killFeed {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 1em;
            text-align: right;
            max-width: 300px;
        }

        .kill {
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            margin: 5px 0;
            border-radius: 3px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        #scoreboard {
            position: absolute;
            top: 50px;
            left: 20px;
            color: white;
            font-size: 1.2em;
        }

        #chat {
            position: absolute;
            bottom: 80px;
            left: 20px;
            width: 400px;
            pointer-events: all;
        }

        #chatMessages {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            color: white;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        #chatInput {
            width: 100%;
            padding: 10px;
            background: rgba(0,0,0,0.7);
            border: 1px solid #ff6b35;
            color: white;
            display: none;
        }

        /* Tela de Morte */
        #deathScreen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,0,0,0.3);
            padding: 50px;
            border-radius: 10px;
            text-align: center;
            color: white;
            font-size: 2em;
            display: none;
        }

        /* Controles */
        #controls {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 15px 30px;
            border-radius: 5px;
            color: white;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <!-- Menu Principal -->
    <div id="mainMenu">
        <h1>üéÆ COUNTER STRIKE 3D</h1>
        <p style="color: #00ff00; font-size: 1.2em; margin-bottom: 20px;">‚ö° Modo Terceira Pessoa ‚ö°</p>
        <input type="text" id="playerName" placeholder="Digite seu nome" maxlength="15">
        <input type="text" id="roomCode" placeholder="C√≥digo da sala (opcional)" maxlength="10">
        <button id="startButton">ENTRAR NA PARTIDA</button>
        <p style="color: #888; margin-top: 20px;">
            WASD - Mover | Mouse - Rotacionar C√¢mera | Click Direito - Mirar<br>
            Click Esquerdo - Atirar | R - Recarregar | 1-3 - Trocar Arma | T - Chat
        </p>
    </div>

    <!-- Game Canvas -->
    <canvas id="gameCanvas"></canvas>

    <!-- HUD -->
    <div id="hud">
        <div id="crosshair"></div>
        <div id="controls">
            üñ±Ô∏è Mouse Livre | Bot√£o Direito - Mirar | Click - Atirar
        </div>
        <div id="stats">
            <div id="health">‚ù§Ô∏è HP: 100</div>
            <div id="weapon">üî´ Pistol</div>
            <div id="ammo">üì¶ 12 / 60</div>
        </div>
        <div id="killFeed"></div>
        <div id="scoreboard">
            <div style="background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px;">
                <div id="score">Kills: 0 | Deaths: 0</div>
            </div>
        </div>
        <div id="chat">
            <div id="chatMessages"></div>
            <input type="text" id="chatInput" placeholder="Pressione T para chat..." maxlength="100">
        </div>
        <div id="deathScreen">
            üíÄ VOC√ä MORREU<br>
            <span style="font-size: 0.5em;">Respawnando em <span id="respawnTimer">5</span>s</span>
        </div>
    </div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ==================== CONFIGURA√á√ÉO FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAIKPooiHzcB5d8_mRiDMyiam4AYel4lZs",
            authDomain: "cs-low-poly.firebaseapp.com",
            databaseURL: "https://cs-low-poly-default-rtdb.firebaseio.com",
            projectId: "cs-low-poly",
            storageBucket: "cs-low-poly.firebasestorage.app",
            messagingSenderId: "291417778108",
            appId: "1:291417778108:web:881869dd93735c6167edb9"
        };

        // Inicializar Firebase
        let database = null;
        let firebaseEnabled = false;
        
        try {
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                firebaseEnabled = true;
                console.log("‚úÖ Firebase conectado!");
            }
        } catch (error) {
            console.warn("‚ö†Ô∏è Firebase offline", error);
            firebaseEnabled = false;
        }

        // ==================== VARI√ÅVEIS GLOBAIS ====================
        let scene, camera, renderer, clock;
        let playerMesh, playerWeapon, players = {};
        let keys = {}, mouse = { x: 0, y: 0 };
        let gameStarted = false;
        let myPlayerId = 'player_' + Math.random().toString(36).substr(2, 9);
        let roomId = 'default_room';
        let isAiming = false;

        // Camera settings (terceira pessoa)
        let cameraDistance = 5;
        let cameraHeight = 2;
        let cameraAngle = { horizontal: 0, vertical: 0.3 };

        // Player stats
        let playerStats = {
            name: '',
            health: 100,
            kills: 0,
            deaths: 0,
            isAlive: true,
            position: { x: 0, y: 0, z: 0 },
            rotation: 0,
            currentWeapon: 0
        };

        // Player physics
        let playerVelocity = new THREE.Vector3();
        let playerSpeed = 5;
        let jumpSpeed = 7;
        let gravity = -20;
        let isGrounded = false;

        // Weapons
        const weapons = [
            { name: 'Pistol', damage: 25, ammo: 12, maxAmmo: 60, fireRate: 300, spread: 0.02, icon: 'üî´', color: 0x333333 },
            { name: 'Rifle', damage: 35, ammo: 30, maxAmmo: 90, fireRate: 100, spread: 0.01, icon: 'üî´', color: 0x1a1a1a },
            { name: 'Knife', damage: 75, ammo: Infinity, maxAmmo: Infinity, fireRate: 500, spread: 0, icon: 'üî™', color: 0xaaaaaa }
        ];
        
        let currentWeapon = weapons[0];
        let currentAmmo = currentWeapon.ammo;
        let reserveAmmo = currentWeapon.maxAmmo;
        let canFire = true;
        let isReloading = false;

        // ==================== INICIALIZA√á√ÉO ====================
        document.getElementById('startButton').addEventListener('click', startGame);
        document.getElementById('playerName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') startGame();
        });

        function startGame() {
            const nameInput = document.getElementById('playerName').value.trim();
            const roomInput = document.getElementById('roomCode').value.trim();
            
            if (!nameInput) {
                alert('Digite seu nome!');
                return;
            }

            playerStats.name = nameInput;
            if (roomInput) roomId = roomInput;

            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            
            initGame();
            gameStarted = true;
        }

        function initGame() {
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            scene.fog = new THREE.Fog(0x87ceeb, 0, 100);

            // Camera (terceira pessoa)
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            // Renderer
            const canvas = document.getElementById('gameCanvas');
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;

            // Clock
            clock = new THREE.Clock();

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(10, 20, 10);
            dirLight.castShadow = true;
            dirLight.shadow.camera.left = -50;
            dirLight.shadow.camera.right = 50;
            dirLight.shadow.camera.top = 50;
            dirLight.shadow.camera.bottom = -50;
            scene.add(dirLight);

            // Create Map
            createMap();

            // Create Player
            createPlayer();

            // Setup Controls
            setupControls();

            // Setup Firebase
            if (firebaseEnabled) {
                setupFirebase();
            }

            // Start Loop
            animate();
        }

        // ==================== MAPA ====================
        function createMap() {
            // Ch√£o
            const floorGeometry = new THREE.PlaneGeometry(100, 100);
            const floorMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x4a7c59,
                roughness: 0.8
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            // Paredes externas
            const walls = [
                { x: 0, z: -50, sx: 100, sz: 2 },
                { x: 0, z: 50, sx: 100, sz: 2 },
                { x: -50, z: 0, sx: 2, sz: 100 },
                { x: 50, z: 0, sx: 2, sz: 100 }
            ];

            walls.forEach(wall => {
                const geometry = new THREE.BoxGeometry(wall.sx, 5, wall.sz);
                const material = new THREE.MeshStandardMaterial({ color: 0x666666 });
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(wall.x, 2.5, wall.z);
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                scene.add(mesh);
            });

            // Caixas espalhadas (estilo CS)
            const boxes = [
                { x: -10, z: -10, s: 2 },
                { x: 10, z: 10, s: 2 },
                { x: -15, z: 15, s: 3 },
                { x: 15, z: -15, s: 2.5 },
                { x: 0, z: 0, s: 2 },
                { x: -20, z: 0, s: 2 },
                { x: 20, z: 0, s: 2 },
                { x: 0, z: -20, s: 3 },
                { x: 0, z: 20, s: 2.5 },
                { x: -25, z: -25, s: 2 },
                { x: 25, z: 25, s: 2 }
            ];

            boxes.forEach(box => {
                const geometry = new THREE.BoxGeometry(box.s, box.s, box.s);
                const material = new THREE.MeshStandardMaterial({ 
                    color: 0x8b7355,
                    roughness: 0.9
                });
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(box.x, box.s / 2, box.z);
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                scene.add(mesh);
            });

            // Spawn inicial
            const spawnPoints = [
                new THREE.Vector3(-30, 0, -30),
                new THREE.Vector3(30, 0, 30),
                new THREE.Vector3(-30, 0, 30),
                new THREE.Vector3(30, 0, -30)
            ];
            
            const spawn = spawnPoints[Math.floor(Math.random() * spawnPoints.length)];
            playerStats.position = { x: spawn.x, y: spawn.y, z: spawn.z };
        }

        // ==================== PLAYER ====================
        function createPlayer() {
            // Corpo do jogador (capsule)
            const bodyGeometry = new THREE.CapsuleGeometry(0.4, 1.2, 4, 8);
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0x0066ff });
            playerMesh = new THREE.Mesh(bodyGeometry, bodyMaterial);
            playerMesh.castShadow = true;
            playerMesh.position.set(
                playerStats.position.x,
                1,
                playerStats.position.z
            );
            scene.add(playerMesh);

            // Cabe√ßa
            const headGeometry = new THREE.SphereGeometry(0.3, 8, 8);
            const headMaterial = new THREE.MeshStandardMaterial({ color: 0xffdbac });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 1;
            head.castShadow = true;
            playerMesh.add(head);

            // Criar arma
            createWeapon();
        }

        function createWeapon() {
            // Remover arma anterior
            if (playerWeapon) {
                playerMesh.remove(playerWeapon);
            }

            // Grupo da arma
            playerWeapon = new THREE.Group();

            if (currentWeapon.name === 'Knife') {
                // Faca
                const handleGeo = new THREE.BoxGeometry(0.05, 0.3, 0.05);
                const handleMat = new THREE.MeshStandardMaterial({ color: 0x8b4513 });
                const handle = new THREE.Mesh(handleGeo, handleMat);
                playerWeapon.add(handle);

                const bladeGeo = new THREE.BoxGeometry(0.03, 0.4, 0.1);
                const bladeMat = new THREE.MeshStandardMaterial({ color: 0xcccccc, metalness: 0.8 });
                const blade = new THREE.Mesh(bladeGeo, bladeMat);
                blade.position.y = 0.35;
                playerWeapon.add(blade);
            } else {
                // Arma de fogo
                const bodyGeo = new THREE.BoxGeometry(0.1, 0.1, 0.6);
                const bodyMat = new THREE.MeshStandardMaterial({ color: currentWeapon.color });
                const body = new THREE.Mesh(bodyGeo, bodyMat);
                playerWeapon.add(body);

                const barrelGeo = new THREE.CylinderGeometry(0.02, 0.02, 0.3);
                const barrelMat = new THREE.MeshStandardMaterial({ color: 0x111111 });
                const barrel = new THREE.Mesh(barrelGeo, barrelMat);
                barrel.rotation.x = Math.PI / 2;
                barrel.position.z = -0.45;
                playerWeapon.add(barrel);

                const handleGeo = new THREE.BoxGeometry(0.08, 0.15, 0.08);
                const handleMat = new THREE.MeshStandardMaterial({ color: 0x654321 });
                const handle = new THREE.Mesh(handleGeo, handleMat);
                handle.position.set(0, -0.1, 0.1);
                playerWeapon.add(handle);
            }

            // Posicionar arma no jogador
            playerWeapon.position.set(0.5, 0.3, 0.3);
            playerWeapon.rotation.y = Math.PI / 4;
            playerMesh.add(playerWeapon);
        }

        // ==================== CONTROLES ====================
        function setupControls() {
            const canvas = document.getElementById('gameCanvas');

            // Keyboard
            document.addEventListener('keydown', (e) => {
                keys[e.key.toLowerCase()] = true;
                
                if (e.key === '1') switchWeapon(0);
                if (e.key === '2') switchWeapon(1);
                if (e.key === '3') switchWeapon(2);
                if (e.key === 'r') reload();
                
                if (e.key === 't') {
                    const chatInput = document.getElementById('chatInput');
                    chatInput.style.display = 'block';
                    chatInput.focus();
                }
            });

            document.addEventListener('keyup', (e) => {
                keys[e.key.toLowerCase()] = false;
            });

            // Mouse movement (rota√ß√£o livre)
            canvas.addEventListener('mousemove', (e) => {
                if (gameStarted) {
                    cameraAngle.horizontal -= e.movementX * 0.003;
                    cameraAngle.vertical -= e.movementY * 0.003;
                    cameraAngle.vertical = Math.max(-Math.PI / 3, Math.min(Math.PI / 3, cameraAngle.vertical));
                }
            });

            // Mouse buttons
            canvas.addEventListener('mousedown', (e) => {
                if (!gameStarted || !playerStats.isAlive) return;
                
                if (e.button === 0) { // Click esquerdo - atirar
                    shoot();
                } else if (e.button === 2) { // Click direito - mirar
                    isAiming = true;
                    cameraDistance = 3;
                }
            });

            canvas.addEventListener('mouseup', (e) => {
                if (e.button === 2) {
                    isAiming = false;
                    cameraDistance = 5;
                }
            });

            // Prevenir menu de contexto
            canvas.addEventListener('contextmenu', (e) => e.preventDefault());

            // Chat
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const message = chatInput.value.trim();
                    if (message && firebaseEnabled) {
                        sendChatMessage(message);
                    }
                    chatInput.value = '';
                    chatInput.style.display = 'none';
                }
            });

            // Resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // ==================== ARMAS ====================
        function switchWeapon(index) {
            if (index < 0 || index >= weapons.length) return;
            
            currentWeapon = weapons[index];
            currentAmmo = currentWeapon.ammo;
            reserveAmmo = currentWeapon.maxAmmo;
            playerStats.currentWeapon = index;
            
            createWeapon();
            updateHUD();
        }

        function reload() {
            if (isReloading || currentAmmo === currentWeapon.ammo || currentWeapon.name === 'Knife') return;
            
            isReloading = true;
            
            setTimeout(() => {
                const needed = currentWeapon.ammo - currentAmmo;
                const toReload = Math.min(needed, reserveAmmo);
                currentAmmo += toReload;
                reserveAmmo -= toReload;
                isReloading = false;
                updateHUD();
            }, 1500);
        }

        function shoot() {
            if (!canFire || isReloading || currentAmmo <= 0) return;
            
            if (currentWeapon.name !== 'Knife') {
                currentAmmo--;
            }
            
            canFire = false;
            setTimeout(() => canFire = true, currentWeapon.fireRate);

            // Anima√ß√£o de recuo da arma
            if (playerWeapon) {
                const originalZ = playerWeapon.position.z;
                playerWeapon.position.z += 0.1;
                setTimeout(() => playerWeapon.position.z = originalZ, 100);
            }

            // Raycast do centro da tela
            const raycaster = new THREE.Raycaster();
            const direction = new THREE.Vector3(0, 0, -1);
            direction.applyQuaternion(camera.quaternion);
            
            // Spread
            const spread = currentWeapon.spread;
            direction.x += (Math.random() - 0.5) * spread;
            direction.y += (Math.random() - 0.5) * spread;
            direction.normalize();
            
            raycaster.set(camera.position, direction);

            // Checar hit em outros jogadores
            const otherPlayers = Object.values(players);
            const intersects = raycaster.intersectObjects(otherPlayers.map(p => p.mesh).filter(Boolean));

            if (intersects.length > 0 && firebaseEnabled) {
                const hitPlayer = intersects[0].object.userData.playerId;
                const isHeadshot = intersects[0].point.y > intersects[0].object.position.y + 0.7;
                const damage = isHeadshot ? currentWeapon.damage * 2 : currentWeapon.damage;
                
                database.ref(`rooms/${roomId}/players/${hitPlayer}/health`).transaction(health => {
                    return Math.max(0, (health || 100) - damage);
                });

                if (isHeadshot) {
                    addKillFeed('üí• HEADSHOT!', '#ff0000');
                }
            }

            // Muzzle flash
            createMuzzleFlash();
            updateHUD();
        }

        function createMuzzleFlash() {
            const flash = new THREE.PointLight(0xffaa00, 3, 5);
            flash.position.copy(playerMesh.position);
            flash.position.y += 0.5;
            scene.add(flash);
            
            setTimeout(() => scene.remove(flash), 50);
        }

        // ==================== MOVIMENTO ====================
        function updatePlayer(delta) {
            if (!playerStats.isAlive) return;

            // Dire√ß√£o de movimento baseada na rota√ß√£o da c√¢mera horizontal
            const moveDirection = new THREE.Vector3();
            
            if (keys.w) moveDirection.z -= 1;
            if (keys.s) moveDirection.z += 1;
            if (keys.a) moveDirection.x -= 1;
            if (keys.d) moveDirection.x += 1;

            moveDirection.normalize();
            moveDirection.applyAxisAngle(new THREE.Vector3(0, 1, 0), cameraAngle.horizontal);

            // Aplicar velocidade
            const speed = playerSpeed * (keys.shift ? 1.5 : 1);
            playerVelocity.x = moveDirection.x * speed;
            playerVelocity.z = moveDirection.z * speed;

            // Gravidade
            playerVelocity.y += gravity * delta;

            // Pulo
            if (keys[' '] && isGrounded) {
                playerVelocity.y = jumpSpeed;
                isGrounded = false;
            }

            // Aplicar movimento
            playerMesh.position.x += playerVelocity.x * delta;
            playerMesh.position.y += playerVelocity.y * delta;
            playerMesh.position.z += playerVelocity.z * delta;

            // Colis√£o com ch√£o
            if (playerMesh.position.y <= 1) {
                playerMesh.position.y = 1;
                playerVelocity.y = 0;
                isGrounded = true;
            }

            // Colis√£o com paredes
            if (Math.abs(playerMesh.position.x) > 48) {
                playerMesh.position.x = Math.sign(playerMesh.position.x) * 48;
                playerVelocity.x = 0;
            }
            if (Math.abs(playerMesh.position.z) > 48) {
                playerMesh.position.z = Math.sign(playerMesh.position.z) * 48;
                playerVelocity.z = 0;
            }

            // Rota√ß√£o do jogador baseada no movimento
            if (moveDirection.length() > 0) {
                playerMesh.rotation.y = Math.atan2(moveDirection.x, moveDirection.z) + Math.PI;
            }

            // Atualizar c√¢mera (terceira pessoa)
            updateCamera();

            // Atualizar Firebase
            playerStats.position = {
                x: playerMesh.position.x,
                y: playerMesh.position.y,
                z: playerMesh.position.z
            };
            playerStats.rotation = playerMesh.rotation.y;

            if (firebaseEnabled) {
                updateFirebasePlayer();
            }
        }

        function updateCamera() {
            // Posi√ß√£o da c√¢mera em terceira pessoa
            const horizontalDist = cameraDistance * Math.cos(cameraAngle.vertical);
            const verticalDist = cameraDistance * Math.sin(cameraAngle.vertical);

            camera.position.x = playerMesh.position.x + horizontalDist * Math.sin(cameraAngle.horizontal);
            camera.position.y = playerMesh.position.y + cameraHeight + verticalDist;
            camera.position.z = playerMesh.position.z + horizontalDist * Math.cos(cameraAngle.horizontal);

            // Olhar para o jogador
            camera.lookAt(playerMesh.position.x, playerMesh.position.y + 1, playerMesh.position.z);
        }

        // ==================== FIREBASE ====================
        function setupFirebase() {
            const playerRef = database.ref(`rooms/${roomId}/players/${myPlayerId}`);
            playerRef.set({
                name: playerStats.name,
                health: playerStats.health,
                kills: playerStats.kills,
                deaths: playerStats.deaths,
                isAlive: playerStats.isAlive,
                position: playerStats.position,
                rotation: playerStats.rotation,
                currentWeapon: playerStats.currentWeapon,
                timestamp: Date.now()
            });

            playerRef.onDisconnect().remove();

            database.ref(`rooms/${roomId}/players`).on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                Object.keys(data).forEach(id => {
                    if (id === myPlayerId) {
                        if (data[id].health <= 0 && playerStats.isAlive) {
                            die();
                        }
                        playerStats.health = data[id].health;
                        updateHUD();
                        return;
                    }

                    if (!players[id]) {
                        createOtherPlayer(id, data[id]);
                    } else {
                        updateOtherPlayer(id, data[id]);
                    }
                });

                Object.keys(players).forEach(id => {
                    if (!data[id]) {
                        removeOtherPlayer(id);
                    }
                });
            });

            database.ref(`rooms/${roomId}/chat`).limitToLast(1).on('child_added', (snapshot) => {
                const msg = snapshot.val();
                if (msg && msg.playerId !== myPlayerId) {
                    addChatMessage(msg.name, msg.message);
                }
            });
        }

        function updateFirebasePlayer() {
            if (!firebaseEnabled) return;
            
            database.ref(`rooms/${roomId}/players/${myPlayerId}`).update({
                position: playerStats.position,
                rotation: playerStats.rotation,
                health: playerStats.health,
                kills: playerStats.kills,
                deaths: playerStats.deaths,
                isAlive: playerStats.isAlive,
                currentWeapon: playerStats.currentWeapon,
                timestamp: Date.now()
            });
        }

        function createOtherPlayer(id, data) {
            const bodyGeometry = new THREE.CapsuleGeometry(0.4, 1.2, 4, 8);
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0xff0000 });
            const mesh = new THREE.Mesh(bodyGeometry, bodyMaterial);
            mesh.castShadow = true;
            mesh.userData.playerId = id;
            scene.add(mesh);

            const headGeometry = new THREE.SphereGeometry(0.3, 8, 8);
            const headMaterial = new THREE.MeshStandardMaterial({ color: 0xffdbac });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 1;
            mesh.add(head);

            // Nome
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 256;
            canvas.height = 64;
            context.fillStyle = 'white';
            context.font = 'Bold 24px Arial';
            context.textAlign = 'center';
            context.fillText(data.name, 128, 40);

            const texture = new THREE.CanvasTexture(canvas);
            const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
            const sprite = new THREE.Sprite(spriteMaterial);
            sprite.position.y = 2;
            sprite.scale.set(2, 0.5, 1);
            mesh.add(sprite);

            players[id] = { mesh, sprite, data };
        }

        function updateOtherPlayer(id, data) {
            if (!players[id]) return;
            
            const player = players[id];
            player.data = data;

            if (data.position) {
                player.mesh.position.lerp(
                    new THREE.Vector3(data.position.x, data.position.y, data.position.z),
                    0.3
                );
            }

            if (data.rotation !== undefined) {
                player.mesh.rotation.y = data.rotation;
            }

            player.mesh.visible = data.isAlive;
        }

        function removeOtherPlayer(id) {
            if (players[id]) {
                scene.remove(players[id].mesh);
                delete players[id];
            }
        }

        // ==================== MORTE E RESPAWN ====================
        function die() {
            playerStats.isAlive = false;
            playerStats.deaths++;
            
            document.getElementById('deathScreen').style.display = 'block';
            playerMesh.visible = false;
            
            let respawnTime = 5;
            const respawnInterval = setInterval(() => {
                respawnTime--;
                document.getElementById('respawnTimer').textContent = respawnTime;
                
                if (respawnTime <= 0) {
                    clearInterval(respawnInterval);
                    respawn();
                }
            }, 1000);
            
            updateHUD();
        }

        function respawn() {
            playerStats.isAlive = true;
            playerStats.health = 100;
            
            const spawnPoints = [
                new THREE.Vector3(-30, 1, -30),
                new THREE.Vector3(30, 1, 30),
                new THREE.Vector3(-30, 1, 30),
                new THREE.Vector3(30, 1, -30)
            ];
            const spawn = spawnPoints[Math.floor(Math.random() * spawnPoints.length)];
            playerMesh.position.copy(spawn);
            playerMesh.visible = true;
            
            switchWeapon(0);
            
            document.getElementById('deathScreen').style.display = 'none';
            
            if (firebaseEnabled) {
                updateFirebasePlayer();
            }
            
            updateHUD();
        }

        // ==================== HUD ====================
        function updateHUD() {
            document.getElementById('health').textContent = `‚ù§Ô∏è HP: ${playerStats.health}`;
            document.getElementById('weapon').textContent = `${currentWeapon.icon} ${currentWeapon.name}`;
            
            if (currentWeapon.name === 'Knife') {
                document.getElementById('ammo').textContent = 'üî™ Melee';
            } else {
                document.getElementById('ammo').textContent = `üì¶ ${currentAmmo} / ${reserveAmmo}`;
            }
            
            document.getElementById('score').textContent = `Kills: ${playerStats.kills} | Deaths: ${playerStats.deaths}`;
        }

        function addKillFeed(text, color = 'white') {
            const feed = document.getElementById('killFeed');
            const killDiv = document.createElement('div');
            killDiv.className = 'kill';
            killDiv.style.color = color;
            killDiv.textContent = text;
            feed.prepend(killDiv);
            
            setTimeout(() => killDiv.remove(), 5000);
        }

        function addChatMessage(name, message) {
            const chat = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.innerHTML = `<strong>${name}:</strong> ${message}`;
            chat.appendChild(msgDiv);
            chat.scrollTop = chat.scrollHeight;
            
            setTimeout(() => msgDiv.remove(), 10000);
        }

        function sendChatMessage(message) {
            if (!firebaseEnabled) return;
            
            database.ref(`rooms/${roomId}/chat`).push({
                playerId: myPlayerId,
                name: playerStats.name,
                message,
                timestamp: Date.now()
            });
            
            addChatMessage(playerStats.name, message);
        }

        // ==================== GAME LOOP ====================
        function animate() {
            requestAnimationFrame(animate);
            
            if (!gameStarted) return;
            
            const delta = Math.min(clock.getDelta(), 0.1);
            
            updatePlayer(delta);
            
            renderer.render(scene, camera);
        }

        // ==================== LOG ====================
        console.log('%cüéÆ CS 3D - Terceira Pessoa', 'font-size: 24px; color: #ff6b35; font-weight: bold;');
        console.log('%c‚úÖ Mouse livre | C√¢mera rotativa | Arma vis√≠vel', 'font-size: 14px; color: #00ff00;');
        console.log('Click Direito - Mirar de perto');
        console.log('Click Esquerdo - Atirar');
        console.log('WASD - Mover');
        console.log('1-3 - Trocar arma');
    </script>
</body>
</html>
